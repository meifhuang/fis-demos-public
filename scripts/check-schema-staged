#!/usr/bin/env sh
set -e

# Check to ensure staged migrations are accompanied by staged schema changes

STAGED_FILES=$(git diff --cached --name-only)

echo "$STAGED_FILES" | grep -q '^supabase/migrations/' && HAS_MIGRATIONS=true || HAS_MIGRATIONS=false
echo "$STAGED_FILES" | grep -q '^supabase/schema/' && HAS_SCHEMA=true || HAS_SCHEMA=false

if [ "$HAS_MIGRATIONS" = true ] && [ "$HAS_SCHEMA" = false ]; then
  cat <<EOF

⚠️  You have staged migration changes but no schema changes.
You may need to run one of the following:
    npm run db:dump (generate the schema)
    npm run db:migrate (run your migration & generate the schema)
    npm run db:reset (reset your local DB & generate the schema)

EOF
  exit 1
fi

if [ "$HAS_MIGRATIONS" = true ] && [ "$HAS_SCHEMA" = true ]; then
  SCHEMA_DIR="./supabase/schema"
  TMP_DIR=$(mktemp -d)

  # Generate a temp schema tree from current DB
  ./scripts/db-dump "$TMP_DIR"

  # Compare directories recursively
  if ! diff -r "$SCHEMA_DIR" "$TMP_DIR" >/dev/null; then
    cat <<EOF

⚠️  The staged schema does not match the current database state.
You may need to run one of the following:
    npm run db:dump (generate the schema)
    npm run db:reset (reset your local DB & generate the schema)

EOF
    rm -rf "$TMP_DIR"
    exit 1
  fi

  # Cleanup
  rm -rf "$TMP_DIR"
fi

exit 0
